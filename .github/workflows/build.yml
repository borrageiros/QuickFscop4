name: Build and Release

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with Docker
        run: |
          docker build -t f4st-build --build-arg BUILD_MODE=release .

      - name: Extract binaries
        run: |
          mkdir -p artifacts
          docker create --name f4st-temp f4st-build
          docker cp f4st-temp:/build/bin ./artifacts/ || true
          docker cp f4st-temp:/build/F4ST.exe ./artifacts/ || true
          docker rm f4st-temp

      - name: Get version
        id: version
        run: |
          VERSION=$(grep -m1 'APP_VERSION' installer.nsi | sed -n 's/.*"\(.*\)".*/\1/p')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: List extracted files
        run: |
          echo "Files in artifacts:"
          find artifacts -type f || true
          ls -la artifacts/bin/ || true

      - name: Rename files for release
        run: |
          mkdir -p artifacts/release
          VERSION="${{ steps.version.outputs.version }}"
          if [ -f "artifacts/bin/32/F4ST.exe" ]; then
            cp artifacts/bin/32/F4ST.exe "artifacts/release/F4ST_v${VERSION}_32bit_Portable.exe"
          fi
          if [ -f "artifacts/bin/64/F4ST.exe" ]; then
            cp artifacts/bin/64/F4ST.exe "artifacts/release/F4ST_v${VERSION}_64bit_Portable.exe"
          fi
          INSTALLER=$(find artifacts/bin -name "F4ST-*.exe" -type f | head -n 1)
          if [ -n "$INSTALLER" ] && [ -f "$INSTALLER" ]; then
            cp "$INSTALLER" "artifacts/release/F4ST_v${VERSION}_Installer.exe"
          fi
          echo "Release files prepared:"
          ls -la artifacts/release/

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            Automated build from commit ${{ github.sha }}
            
            **Binaries included:**
            - **32-bit (Portable)**: `F4ST_v${{ steps.version.outputs.version }}_32bit_Portable.exe`
            - **64-bit (Portable)**: `F4ST_v${{ steps.version.outputs.version }}_64bit_Portable.exe`
            - **Installer**: `F4ST_v${{ steps.version.outputs.version }}_Installer.exe`
          files: |
            artifacts/release/F4ST_v${{ steps.version.outputs.version }}_32bit_Portable.exe
            artifacts/release/F4ST_v${{ steps.version.outputs.version }}_64bit_Portable.exe
            artifacts/release/F4ST_v${{ steps.version.outputs.version }}_Installer.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

